# ゲームシーケンス計画 (詳細版)

## 1. ゲームフェーズの定義

ゲームは以下の主要なフェーズで進行する。

*   **`setup`**: ゲーム開始前の準備フェーズ。
    *   `initialPokemonSelection`: プレイヤーが初期ポケモン（バトル場とベンチ）を選択する。
*   **`playerTurn`**: プレイヤーの番。
*   **`cpuTurn`**: CPUの番。
*   **`gameOver`**: ゲーム終了フェーズ。

## 2. 詳細なターンシーケンスとアニメーション

### 2.1. `setup` フェーズ

**目的**: プレイヤーとCPUが対戦準備を完了する。

**シーケンス**:

1.  **デッキ作成 & シャッフル (`Logic.setupGame`)**
    *   **アニメーション**: デッキがシャッフルされる視覚効果（例: カードが高速で入れ替わる、デッキが揺れる）。
2.  **初期手札ドロー (7枚) & マリガン (`Logic.setupGame`)**
    *   **アニメーション**:
        *   デッキからカードが手札に移動するアニメーション。
        *   マリガン時: 手札がデッキに戻り、デッキが再度シャッフルされ、新しい手札がドローされるアニメーション。
    *   **UI**: マリガンが発生した場合、メッセージ表示 (`game.message`)。
3.  **`initialPokemonSelection` フェーズへの移行 (`game.js` `init` -> `updateState`)**
    *   **UI**: セットアップオーバーレイが表示され、プレイヤーの手札からたねポケモンがハイライト表示される。
    *   **アニメーション**: オーバーレイがフェードインする。

#### 2.1.1. `initialPokemonSelection` サブフェーズ (プレイヤー操作)

**目的**: プレイヤーがバトル場とベンチの初期ポケモンを選択する。

**シーケンス**:

1.  **プレイヤーが手札のたねポケモンをクリック (`Game.handleSetupHandClick`)**
    *   **UI**: クリックされたカードがハイライト表示される (`.selected` クラス)。
    *   **アニメーション**: カードが少し浮き上がる、または枠が光る。
2.  **プレイヤーがバトル場スロットをクリック (`Game.handleSetupSlotClick`)**
    *   **条件**: `currentCard`が設定されていること。
    *   **アクション**: `currentCard`がバトル場スロットに移動し、`setupSelection.active`に設定される。手札からカードが削除される。
    *   **UI**: バトル場スロットに選択されたポケモンが表示される。手札からカードが消える。
    *   **アニメーション**: カードが手札からバトル場スロットへ移動するアニメーション。
3.  **プレイヤーがベンチスロットをクリック (`Game.handleSetupSlotClick`)**
    *   **条件**: `currentCard`が設定されていること。ベンチが5体未満であること。
    *   **アクション**: `currentCard`がベンチスロットに移動し、`setupSelection.bench`に追加される。手札からカードが削除される。
    *   **UI**: ベンチスロットに選択されたポケモンが表示される。手札からカードが消える。
    *   **アニメーション**: カードが手札からベンチスロットへ移動するアニメーション。
4.  **プレイヤーが「確定」ボタンをクリック (`Game.handleSetupConfirm`)**
    *   **条件**: バトルポケモンが選択されていること (`setupSelection.active`が`null`でないこと)。
    *   **アクション**:
        *   `setupSelection`の内容が実際の`state.players.player.activePokemon`と`state.players.player.bench`に反映される。
        *   CPUの初期ポケモン（バトル場とベンチ）が自動で選択・配置される。
        *   両プレイヤーのサイドカード (6枚) がデッキから配置される。
        *   `gamePhase`が `playerTurn` に移行する。
    *   **UI**: セットアップオーバーレイが非表示になる。メインゲームボードが表示される。
    *   **アニメーション**: オーバーレイがフェードアウトする。バトル場とベンチのポケモンが表向きになるアニメーション。サイドカードがデッキから配置されるアニメーション。

### 2.2. `playerTurn` フェーズ

**目的**: プレイヤーが自分の番にできるアクションを実行する。

**シーケンス**:

1.  **ターン開始時のドロー (`Logic.drawCard`)**
    *   **UI**: メッセージ表示 (`game.message`)。
    *   **アニメーション**: デッキからカードが手札に移動するアニメーション。
2.  **プレイヤーアクション (任意の順序、回数制限あり)**
    *   **手札からたねポケモンをベンチに出す (`Game.handleCardClick` -> `Logic.playBasicPokemon`)**
        *   **UI**: 手札のたねポケモンがクリック可能に。ベンチスロットがハイライトされる。
        *   **アニメーション**: カードが手札からベンチへ移動するアニメーション。
    *   **手札からエネルギーをポケモンにつける (`Game.handleCardClick` -> `Logic.attachEnergy`)**
        *   **UI**: 手札のエネルギーカードがクリック可能に。バトル場/ベンチのポケモンがハイライトされる。
        *   **アニメーション**: エネルギーカードが手札からポケモンへ移動し、ポケモンにアタッチされるアニメーション。
    *   **トレーナーズカードを使用 (未実装)**
    *   **特性を使用 (未実装)**
    *   **ポケモンを進化させる (未実装)**
    *   **バトルポケモンをにがす (`Game.handleRetreat` -> `Logic.retreatPokemon`)**
        *   **UI**: 「にげる」ボタンがクリック可能に。ベンチポケモンが選択可能に。
        *   **アニメーション**: バトルポケモンがベンチへ、ベンチポケモンがバトル場へ移動するアニメーション。にげるコストのエネルギーがトラッシュへ移動するアニメーション。
3.  **攻撃 (`Game.handleAttack` -> `Logic.useAttack`)**
    *   **条件**: ターンに1回のみ。必要なエネルギーがアタッチされていること。
    *   **UI**: 「攻撃」ボタンがクリック可能に。
    *   **アニメーション**:
        *   攻撃エフェクト（例: 攻撃ポケモンから相手ポケモンへのエフェクト）。
        *   ダメージ表示（ダメカンが乗るアニメーション）。
        *   きぜつ時: きぜつしたポケモンがトラッシュへ移動するアニメーション。サイドカードが手札に移動するアニメーション。
    *   **アクション**: 攻撃後、ターン終了へ自動移行。
4.  **ターン終了 (`Game.handleEndTurn` -> `Logic.endTurn`)**
    *   **UI**: 「ターン終了」ボタンがクリック可能に。
    *   **アクション**: `currentTurnPlayerId`が切り替わり、`turnCount`が増加する。

### 2.3. `cpuTurn` フェーズ

**目的**: CPUが自分の番にできるアクションを実行する。

**シーケンス**:

1.  **ターン開始時のドロー (`Logic.drawCard`)**
    *   **UI**: メッセージ表示 (`game.message`)。
    *   **アニメーション**: デッキからカードがCPUの手札に移動するアニメーション（裏向き）。
2.  **CPUアクション (`Logic.cpuTurn`)**
    *   **たねポケモンをベンチに出す**: CPUの手札からたねポケモンをベンチに出す。
        *   **アニメーション**: カードがCPUの手札からベンチへ移動するアニメーション。
    *   **エネルギーをポケモンにつける**: CPUのアクティブポケモンにエネルギーをつける。
        *   **アニメーション**: エネルギーカードがCPUの手札からポケモンへ移動し、ポケモンにアタッチされるアニメーション。
    *   **攻撃**: 攻撃可能な場合、攻撃する。
        *   **アニメーション**: 攻撃エフェクト、ダメージ表示、きぜつ時アニメーション。
3.  **ターン終了 (`Logic.endTurn`)**
    *   **アクション**: `currentTurnPlayerId`が切り替わり、`turnCount`が増加する。

### 2.4. `gameOver` フェーズ

**目的**: どちらかのプレイヤーが勝利条件を満たしたときにゲームを終了する。

**シーケンス**:

1.  **勝利条件チェック (`Logic.checkWinCondition`)**
    *   **条件**: サイドカードが0枚、バトルポケモンが出せない、山札切れなど。
2.  **ゲーム終了 (`Game.updateState`)**
    *   **UI**: 勝利メッセージが表示される。ゲームボード上の操作が無効になる。
    *   **アニメーション**: 勝利演出（例: 画面が光る、勝利プレイヤーのポケモンが強調される）。

## 3. UI/UXの考慮事項

*   **フィードバック**: プレイヤーのアクション（カードを引く、ダメージを与えるなど）に対して、常に視覚的・テキスト的なフィードバックを提供する。
*   **選択状態の明示**: クリック可能なカードやスロットはハイライト表示する。選択中のカードは明確に区別する。
*   **エラーメッセージ**: 不正な操作やルール違反があった場合、明確なメッセージでプレイヤーに通知する。
*   **アニメーションの速度**: アニメーションはゲームのテンポを損なわない適切な速度に設定する。

## 4. コードへのマッピング

*   **`state.js`**: ゲームのあらゆる状態を保持する。
*   **`logic.js`**: 各アクションのルール処理と状態遷移を担当する純粋関数群。
*   **`view.js`**: `state`オブジェクトをDOMにマッピングし、UIの描画とアニメーションを担当する。
*   **`game.js`**: コントローラーとして、ユーザー入力やCPUの行動に応じて`Logic`を呼び出し、`state`を更新し、`View`に描画を指示する。フェーズ管理もここで行う。
