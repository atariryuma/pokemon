<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ポケモンカード エディタ</title>
  <style>
    :root {
      --bg: #0f1226;
      --panel: #15193a;
      --panel-2: #1c2252;
      --text: #e7ecff;
      --muted: #9fb0ff;
      --accent: #6ea8ff;
      --accent-2: #8ef6ff;
      --danger: #ff6b6b;
      --ok: #2ecc71;
      --warn: #f1c40f;
      --border: rgba(255,255,255,0.1);
      --chip: #2b3169;
      --shadow: 0 12px 32px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #2945b5 0%, transparent 60%),
                  radial-gradient(1200px 600px at 110% 10%, #4026a7 0%, transparent 60%),
                  var(--bg);
    }

    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(15,18,38,.95) 0%, rgba(15,18,38,.75) 100%);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
      padding: 14px 20px;
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 12px;
      align-items: center;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: .5px; }
    .muted { color: var(--muted); }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: .15s ease transform, .2s ease filter, .2s ease box-shadow;
      box-shadow: 0 2px 0 rgba(0,0,0,.3) inset, 0 1px 0 rgba(255,255,255,.04) inset;
      font-weight: 600; font-size: 13px;
    }
    .btn:hover { filter: brightness(1.2); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: rgba(110,168,255,.5); box-shadow: 0 0 0 1px rgba(110,168,255,.25); }
    .btn.warn { border-color: rgba(241,196,15,.5); }
    .btn.danger { border-color: rgba(255,107,107,.5); }
    .btn.ghost { background: transparent; }

    .toolbar { display: flex; gap: 8px; align-items: center; }
    .spacer { flex: 1; }
    .kbd { background: var(--chip); padding: 2px 6px; border-radius: 6px; border:1px solid var(--border); font-size: 12px; }

    .container { display: grid; grid-template-columns: minmax(420px, 44vw) 1fr; gap: 16px; padding: 16px; }
    .panel {
      background: linear-gradient(180deg, rgba(21,25,58,.85) 0%, rgba(28,34,82,.85) 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel h2 { font-size: 14px; margin: 0; padding: 12px 14px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,.15); }
    .panel .content { padding: 12px; }

    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .field { display: grid; gap: 6px; margin-bottom: 10px; }
    .field label { font-size: 12px; color: var(--muted); }
    .field input, .field select, .field textarea {
      width: 100%;
      background: rgba(0,0,0,.2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px; padding: 8px 10px; font-size: 13px;
    }
    .field textarea { min-height: 70px; resize: vertical; }
    .chips { display:flex; flex-wrap: wrap; gap:6px; }
    .chip { background: var(--chip); padding: 4px 8px; border-radius: 20px; border:1px solid var(--border); font-size: 12px; }
    .hint { color: var(--muted); font-size: 12px; }

    .list-toolbar { padding: 10px; border-bottom: 1px solid var(--border); display:flex; gap:8px; align-items:center; }
    .search { flex: 1; }
    .search input { width: 100%; padding: 8px 10px; border-radius: 10px; border:1px solid var(--border); background: rgba(0,0,0,.2); color: var(--text); }

    .list { max-height: calc(100vh - 220px); overflow: auto; }
    .card-item { display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; padding: 8px 10px; border-bottom:1px solid var(--border); cursor:pointer; }
    .card-item:hover { background: rgba(255,255,255,.04); }
    .card-item.active { background: rgba(110,168,255,.15); }
    .badge { padding: 2px 8px; border-radius: 14px; font-size: 11px; border:1px solid var(--border); background: rgba(255,255,255,.06); }
    .badge.pokemon { color:#ffd2d2; border-color: rgba(255,107,107,.4) }
    .badge.energy { color:#fff0b6; border-color: rgba(241,196,15,.4) }
    .badge.trainer{ color:#b8e1ff; border-color: rgba(142,246,255,.4) }
    .count { font-size: 12px; color: var(--muted); padding: 0 10px 10px; }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .flex-row { display:flex; gap:8px; }
    .right { text-align: right; }

    .section { margin: 8px 0 14px; padding-top: 8px; border-top:1px dashed var(--border); }
    .section h3 { font-size: 12px; margin: 0 0 8px; color: var(--muted); }

    .attacks { display: grid; gap: 8px; }
    .attack-box { border:1px solid var(--border); background: rgba(0,0,0,.15); border-radius: 10px; padding: 10px; }
    .attack-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }

    .footer { padding: 12px 16px; display:flex; gap: 8px; align-items:center; border-top:1px solid var(--border); background: rgba(0,0,0,.15); }
    .status { font-size: 12px; color: var(--muted); }

    .danger-zone { border:1px solid rgba(255,107,107,.3); background: rgba(255,107,107,.06); border-radius: 12px; padding: 10px; }
    .small { font-size: 12px; }

    .invisible { display:none; }

    /* Preview styles */
    #preview-stage { position: relative; height: calc(100vh - 260px); background: repeating-conic-gradient(#1a1f4a 0 25%, #10143a 0 50%) 50% / 18px 18px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display:flex; align-items:center; justify-content:center; }
    #preview-img { max-width: 100%; max-height: 100%; transform-origin: center center; user-select: none; -webkit-user-drag: none; image-rendering: auto; }
    #preview-empty { position: absolute; color: var(--muted); font-size: 12px; }

    /* Drawer */
    #drawer { position: fixed; inset: 0; pointer-events: none; }
    .drawer-panel { position: absolute; top: 0; left: -420px; width: 400px; height: 100%; background: linear-gradient(180deg, rgba(21,25,58,.98) 0%, rgba(28,34,82,.98) 100%); border-right: 1px solid var(--border); box-shadow: var(--shadow); transition: left .25s ease; display:flex; flex-direction:column; pointer-events: auto; }
    .drawer-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.3); opacity: 0; transition: opacity .25s ease; }
    #drawer.open .drawer-panel { left: 0; }
    #drawer.open .drawer-backdrop { opacity: 1; pointer-events: auto; }
    #btn-open-drawer { white-space: nowrap; }

    /* Header unsaved indicator */
    header h1::after { content: var(--unsaved-dot, ""); margin-left: 8px; color: var(--warn); }
  
    @media (max-width: 1024px) {
      .container { grid-template-columns: 1fr; }
      #preview-stage { height: 52vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ポケモンカード エディタ <span class="muted small">(cards-master.json / data/cards)</span></h1>
    <div class="toolbar">
      <button class="btn" id="btn-open-drawer">カード一覧 (Ctrl+K)</button>
      <button class="btn" id="btn-connect">フォルダ接続</button>
      <button class="btn" id="btn-open-master">master読込</button>
      <button class="btn primary" id="btn-save-master">master保存</button>
      <button class="btn warn" id="btn-validate">互換チェック</button>
      <div class="spacer"></div>
      <button class="btn" id="btn-export">バックアップ書き出し</button>
    </div>
  </header>

  <div class="container">
    <section class="panel" id="preview-panel">
      <h2>プレビュー</h2>
      <div class="content" id="preview-wrap">
        <div id="preview-stage">
          <img id="preview-img" alt="preview" />
          <div id="preview-empty">画像がありません。画像を選択/ドロップしてください。</div>
        </div>
        <div class="flex-row" style="align-items:center; margin-top:8px;">
          <div class="toolbar">
            <button class="btn" id="btn-zoom-out">-</button>
            <input type="range" id="zoom" min="0.5" max="3" value="1" step="0.1" style="width:160px"/>
            <button class="btn" id="btn-zoom-in">+</button>
            <button class="btn" id="btn-fit">フィット</button>
            <button class="btn" id="btn-actual">等倍</button>
          </div>
          <div class="spacer"></div>
          <div class="toolbar">
            <button class="btn" id="btn-prev">← 前へ</button>
            <button class="btn" id="btn-next">次へ →</button>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="editor-panel">
      <h2>カード編集</h2>
      <div class="content">
        <form id="cardForm">
          <div class="grid-2">
            <div class="field"><label>ID</label><input id="id" required /></div>
            <div class="field"><label>カード種別</label>
              <select id="card_type" required>
                <option value="Pokemon">Pokemon</option>
                <option value="Energy">Energy</option>
                <option value="Trainer">Trainer</option>
              </select>
            </div>
          </div>
          <div class="grid-2">
            <div class="field"><label>英名 (name_en)</label><input id="name_en" required /></div>
            <div class="field"><label>和名 (name_ja)</label><input id="name_ja" required /></div>
          </div>

          <div id="pokemonFields" class="section">
            <h3>ポケモン</h3>
            <div class="grid-2">
              <div class="field"><label>ステージ</label>
                <select id="stage">
                  <option value="">-</option>
                  <option value="Basic">Basic</option>
                  <option value="Stage1">Stage1</option>
                  <option value="Stage2">Stage2</option>
                </select>
              </div>
              <div class="field"><label>HP</label><input id="hp" type="number" min="0" /></div>
            </div>
            <div class="grid-2">
              <div class="field"><label>進化前 (evolves_from)</label><input id="evolves_from"/></div>
              <div class="field"><label>進化先 (evolves_to, カンマ区切り)</label><input id="evolves_to"/></div>
            </div>
            <div class="grid-2">
              <div class="field"><label>タイプ (types, カンマ区切り)</label><input id="types" placeholder="Grass, Colorless 等"/></div>
              <div class="field"><label>ルールボックス</label>
                <select id="rule_box">
                  <option value="">なし</option>
                  <option value="ex">ex</option>
                  <option value="V">V</option>
                  <option value="VMAX">VMAX</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="field"><label>弱点 (例: Lightning:x2; Fire:+)</label><input id="weakness" placeholder="type:value; type:value"/></div>
              <div class="field"><label>抵抗力 (例: Fighting:-30)</label><input id="resistance" placeholder="type:value (1つのみ)"/></div>
            </div>
            <div class="grid-2">
              <div class="field"><label>にげるエネ数 (retreat_cost)</label><input id="retreat_cost" type="number" min="0" max="5"/></div>
              <div class="field"><label>特性 名 (ability.name_ja / en)</label><input id="ability_name"/></div>
            </div>
            <div class="field"><label>特性 テキスト (text_ja / text_en)</label><textarea id="ability_text" placeholder="日/英はスラッシュ区切り (日本語 / English)"></textarea></div>

            <div class="section">
              <div class="flex-row" style="justify-content:space-between; align-items:center;">
                <h3>ワザ (attacks)</h3>
                <button type="button" class="btn small" id="btn-add-attack">+ 追加</button>
              </div>
              <div class="attacks" id="attacks"></div>
            </div>
          </div>

          <div id="energyFields" class="section">
            <h3>エネルギー</h3>
            <div class="grid-2">
              <div class="field"><label>エネルギータイプ</label>
                <select id="energy_type">
                  <option value="">-</option>
                  <option>Grass</option><option>Fire</option><option>Water</option>
                  <option>Lightning</option><option>Psychic</option><option>Fighting</option>
                  <option>Darkness</option><option>Metal</option><option>Fairy</option>
                  <option>Dragon</option><option>Colorless</option>
                </select>
              </div>
              <div class="field"><label>基本エネ?</label>
                <select id="is_basic"><option value="true">true</option><option value="false">false</option></select>
              </div>
            </div>
            <div class="field"><label>テキスト (text_ja / text_en)</label><textarea id="energy_text" placeholder="日本語 / English"></textarea></div>
          </div>

          <div id="trainerFields" class="section">
            <h3>トレーナー</h3>
            <div class="grid-2">
              <div class="field"><label>トレーナータイプ</label>
                <select id="trainer_type">
                  <option value="">-</option>
                  <option>Item</option>
                  <option>Supporter</option>
                  <option>Stadium</option>
                </select>
              </div>
            </div>
            <div class="field"><label>テキスト (text_ja / text_en)</label><textarea id="trainer_text" placeholder="日本語 / English"></textarea></div>
          </div>

          <div class="section">
            <h3>画像ファイル</h3>
            <div class="grid-2">
              <div class="field"><label>画像ファイル名 (任意)</label><input id="image_file" placeholder="例: SV1-001.webp"/></div>
              <div class="field"><label>画像アップロード</label><input id="image_upload" type="file" accept="image/*"/></div>
            </div>
            <div class="flex-row" style="align-items:center; gap:8px; margin-top:6px;">
              <button type="button" class="btn" id="btn-pick-image">画像を選ぶ</button>
              <button type="button" class="btn" id="btn-guess-image">英名から推測</button>
              <span class="hint">assets/cards/{pokemon|energy|trainer}/ に保存可能 (File System Access対応ブラウザ)</span>
            </div>
          </div>
        </form>
      </div>
      <div class="footer">
        <div class="toolbar">
          <button class="btn primary" id="btn-save">このカードを保存</button>
          <button class="btn" id="btn-save-card-json">個別JSON</button>
          <button class="btn" id="btn-duplicate">複製</button>
          <button class="btn danger" id="btn-delete">削除</button>
        </div>
        <div class="spacer"></div>
        <div class="status" id="status">準備中...</div>
      </div>
    </section>
  </div>

  <!-- Slide-out drawer: カード一覧 -->
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-panel">
      <div class="list-toolbar">
        <div class="search"><input id="search" placeholder="検索: 英名/和名/ID (Escで閉じる)" /></div>
        <select id="filterType" class="btn">
          <option value="all">全て</option>
          <option value="Pokemon">ポケモン</option>
          <option value="Energy">エネルギー</option>
          <option value="Trainer">トレーナー</option>
        </select>
        <button class="btn" id="btn-new">新規</button>
        <button class="btn ghost" id="btn-close-drawer">✕</button>
      </div>
      <div class="count" id="count"></div>
      <div class="list" id="cardList"></div>
    </div>
    <div class="drawer-backdrop" id="drawer-backdrop"></div>
  </aside>

  <!-- Modal -->
  <div id="modal" class="invisible">
    <div id="modal-backdrop" style="position:fixed; inset:0; background:rgba(0,0,0,.45);"></div>
    <div id="modal-panel" style="position:fixed; top:10%; left:50%; transform:translateX(-50%); width: min(720px, 92vw); max-height: 80vh; overflow:auto; background: linear-gradient(180deg, rgba(21,25,58,.98), rgba(28,34,82,.98)); border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); padding: 16px;"></div>
  </div>

  <script>
    // --------- 型・初期データ
    const defaultCard = () => ({ id: '', name_en: '', name_ja: '', card_type: 'Pokemon' });
    let cards = [];
    let filtered = [];
    let activeIndex = -1;

    // File System Access handles (任意)
    let dataDirHandle = null;              // data/
    let masterFileHandle = null;           // data/cards-master.json
    let perCardDirHandle = null;           // data/cards/
    let assetsDirHandle = null;            // assets/cards/
    let unsaved = false;                   // 未保存フラグ

    // Preview state
    let zoomLevel = 1;
    let pan = { x: 0, y: 0 };
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let lastPan = { x: 0, y: 0 };

    // --------- ユーティリティ
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const byId = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    const schemaGuard = (obj) => {
      // 入力フォーム → スキーマ整形
      const card_type = byId('card_type').value;
      const base = {
        id: byId('id').value.trim(),
        name_en: byId('name_en').value.trim(),
        name_ja: byId('name_ja').value.trim(),
        card_type
      };
      if (card_type === 'Pokemon') {
        const abilityText = byId('ability_text').value.trim();
        const [ability_ja, ability_en_text] = abilityText.split('/').map(s => (s||'').trim());
        const weakStr = byId('weakness').value.trim();
        const weakness = weakStr ? weakStr.split(';').map(s => s.trim()).filter(Boolean).map(tok => {
          const [type, value] = tok.split(':').map(t=>t.trim());
          return { type, value };
        }) : undefined;
        const resStr = byId('resistance').value.trim();
        const resistance = resStr ? (()=>{ const [type,value] = resStr.split(':').map(s=>s.trim()); return { type, value }; })() : undefined;

        obj = {
          ...base,
          stage: byId('stage').value || undefined,
          evolves_from: byId('evolves_from').value.trim() || undefined,
          evolves_to: (byId('evolves_to').value.trim() ? byId('evolves_to').value.split(',').map(s=>s.trim()).filter(Boolean) : undefined),
          hp: byId('hp').value ? Number(byId('hp').value) : undefined,
          types: (byId('types').value.trim() ? byId('types').value.split(',').map(s=>s.trim()).filter(Boolean) : undefined),
          rule_box: (byId('rule_box').value || undefined),
          weakness,
          resistance,
          retreat_cost: byId('retreat_cost').value ? Number(byId('retreat_cost').value) : 0,
          ability: (byId('ability_name').value.trim() || abilityText) ? {
            name_en: byId('ability_name').value.trim() || '',
            name_ja: byId('ability_name').value.trim() || '',
            text_en: ability_en_text || '',
            text_ja: ability_ja || ''
          } : undefined,
          attacks: readAttacksFromForm(),
        };
      } else if (card_type === 'Energy') {
        const txt = byId('energy_text').value.trim();
        const [ja, en] = txt.split('/').map(s => (s||'').trim());
        obj = {
          ...base,
          energy_type: byId('energy_type').value || undefined,
          is_basic: byId('is_basic').value === 'true',
          text_en: en || undefined,
          text_ja: ja || undefined,
        };
      } else if (card_type === 'Trainer') {
        const txt = byId('trainer_text').value.trim();
        const [ja, en] = txt.split('/').map(s => (s||'').trim());
        obj = {
          ...base,
          trainer_type: byId('trainer_type').value || undefined,
          text_en: en || undefined,
          text_ja: ja || undefined,
        };
      }
      const img = byId('image_file').value.trim();
      if (img) obj.image_file = img; // 任意プロパティ
      return compactObject(obj);
    };

    function compactObject(o){
      if (o === null || o === undefined) return undefined;
      if (Array.isArray(o)) {
        const arr = o.map(compactObject).filter(v => v !== undefined);
        return arr.length ? arr : undefined;
      }
      if (typeof o === 'object') {
        const out = {};
        for (const [k,v] of Object.entries(o)) {
          const vv = compactObject(v);
          if (vv !== undefined && vv !== '') out[k] = vv;
        }
        return Object.keys(out).length ? out : undefined;
      }
      return o;
    }

    function readAttacksFromForm(){
      const containers = $$('#attacks .attack-box');
      return containers.map(node => {
        const name = node.querySelector('.atk-name').value.trim();
        const nameEn = node.querySelector('.atk-name-en').value.trim();
        const cost = node.querySelector('.atk-cost').value.trim();
        const dmg = node.querySelector('.atk-dmg').value;
        const text = node.querySelector('.atk-text').value.trim();
        const [ja, en] = text.split('/').map(s => (s||'').trim());
        const costArray = cost ? cost.split(',').map(s=>s.trim()).filter(Boolean) : [];
        const atk = {
          name_ja: name || undefined,
          name_en: nameEn || undefined,
          cost: costArray,
        };
        if (dmg !== '') atk.damage = Number(dmg);
        if (ja) atk.text_ja = ja;
        if (en) atk.text_en = en;
        return atk;
      });
    }

    function writeAttacksToForm(attacks){
      const root = byId('attacks');
      root.innerHTML = '';
      (attacks || []).forEach((a, idx) => root.appendChild(createAttackBox(a, idx)));
    }

    function createAttackBox(a = {}, idx = 0){
      const box = document.createElement('div');
      box.className = 'attack-box';
      box.innerHTML = `
        <div class="attack-grid">
          <div class="field"><label>技名(和)</label><input class="atk-name" value="${a.name_ja||''}"></div>
          <div class="field"><label>技名(英)</label><input class="atk-name-en" value="${a.name_en||''}"></div>
          <div class="field"><label>コスト(カンマ)</label><input class="atk-cost" placeholder="Grass,Colorless" value="${(a.cost||[]).join(',')}"></div>
        </div>
        <div class="attack-grid">
          <div class="field"><label>ダメージ</label><input class="atk-dmg" type="number" min="0" value="${a.damage ?? ''}"></div>
          <div class="field" style="grid-column: span 2"><label>テキスト(日/英)</label><input class="atk-text" placeholder="日本語 / English" value="${[a.text_ja||'', a.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ')}"></div>
        </div>
        <div class="right"><button type="button" class="btn danger btn-del-atk">削除</button></div>
      `;
      box.querySelector('.btn-del-atk').addEventListener('click', () => {
        box.remove();
      });
      return box;
    }

    function setStatus(msg){ byId('status').textContent = msg; }
    function markUnsaved(flag = true){
      unsaved = flag;
      document.documentElement.style.setProperty('--unsaved-dot', flag ? '"●"' : '""');
      if (flag) setStatus('未保存の変更があります');
    }

    // --------- リスト表示
    function renderList(){
      const q = byId('search').value.trim().toLowerCase();
      const f = byId('filterType').value;
      filtered = cards.filter(c =>
        (f==='all'||c.card_type===f) &&
        ([c.id, c.name_en, c.name_ja].join(' ').toLowerCase().includes(q))
      );
      const list = byId('cardList');
      list.innerHTML = '';
      filtered.forEach((c, i) => {
        const row = document.createElement('div');
        const isActive = cards[activeIndex] === c;
        row.className = 'card-item' + (isActive ? ' active' : '');
        const badgeClass = c.card_type === 'Pokemon' ? 'pokemon' : (c.card_type === 'Energy' ? 'energy' : 'trainer');
        row.innerHTML = `
          <span class="badge ${badgeClass}">${c.card_type}</span>
          <div>
            <div><strong>${c.name_ja||''}</strong> <span class="muted">${c.name_en||''}</span></div>
            <div class="small muted">${c.id||''}</div>
          </div>
          <div class="small muted">${summary(c)}</div>
        `;
        row.addEventListener('click', () => selectByFilteredIndex(i));
        list.appendChild(row);
      });
      byId('count').textContent = `表示 ${filtered.length} / 全体 ${cards.length}`;
    }

    function summary(c){
      if (c.card_type === 'Pokemon') return [c.stage, c.hp?`HP${c.hp}`:'', (c.types||[]).join('/')].filter(Boolean).join(' · ');
      if (c.card_type === 'Energy') return [c.energy_type, c.is_basic? 'Basic':'' ].filter(Boolean).join(' · ');
      if (c.card_type === 'Trainer') return c.trainer_type || '';
      return '';
    }

    function selectByFilteredIndex(fi){
      const card = filtered[fi];
      const absoluteIndex = cards.findIndex(c => c === card);
      if (absoluteIndex === -1) return;
      activeIndex = absoluteIndex;
      writeForm(cards[activeIndex]);
      updatePreview();
      renderList();
    }

    // --------- フォーム <-> データ
    function writeForm(card){
      const c = card || defaultCard();
      byId('id').value = c.id || '';
      byId('card_type').value = c.card_type || 'Pokemon';
      byId('name_en').value = c.name_en || '';
      byId('name_ja').value = c.name_ja || '';

      // Pokemon
      byId('stage').value = c.stage || '';
      byId('hp').value = c.hp ?? '';
      byId('evolves_from').value = c.evolves_from || '';
      byId('evolves_to').value = (c.evolves_to||[]).join(',');
      byId('types').value = (c.types||[]).join(',');
      byId('rule_box').value = c.rule_box || '';
      byId('weakness').value = (c.weakness||[]).map(w=>`${w.type}:${w.value}`).join('; ');
      byId('resistance').value = c.resistance? `${c.resistance.type}:${c.resistance.value}` : '';
      byId('retreat_cost').value = c.retreat_cost ?? '';
      byId('ability_name').value = c.ability?.name_ja || '';
      byId('ability_text').value = [c.ability?.text_ja||'', c.ability?.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ');
      writeAttacksToForm(c.attacks);

      // Energy
      byId('energy_type').value = c.energy_type || '';
      byId('is_basic').value = String(!!c.is_basic);
      byId('energy_text').value = [c.text_ja||'', c.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ');

      // Trainer
      byId('trainer_type').value = c.trainer_type || '';
      byId('trainer_text').value = [c.text_ja||'', c.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ');

      // Image
      byId('image_file').value = c.image_file || '';

      onTypeChange();
      setStatus('編集: ' + (c.id || '(新規)'));
      updatePreview();
    }

    function readForm(){
      return schemaGuard({});
    }

    function onTypeChange(){
      const t = byId('card_type').value;
      byId('pokemonFields').style.display = (t==='Pokemon') ? '' : 'none';
      byId('energyFields').style.display  = (t==='Energy') ? '' : 'none';
      byId('trainerFields').style.display = (t==='Trainer') ? '' : 'none';
    }

    // --------- CRUD
    function newCard(){
      const c = defaultCard();
      activeIndex = cards.push(c) - 1;
      writeForm(c);
      renderList();
      updatePreview();
      markUnsaved(true);
    }

    function saveCurrentIntoList(){
      const data = readForm();
      if (!data || !data.id || !data.name_en || !data.name_ja || !data.card_type){
        alert('必須: id / name_en / name_ja / card_type');
        return false;
      }
      const dup = cards.findIndex((c, i) => c.id === data.id && i !== activeIndex);
      if (dup !== -1){
        alert('同じIDが既に存在します: ' + data.id);
        return false;
      }
      if (activeIndex === -1){
        activeIndex = cards.push(data) - 1;
      } else {
        cards[activeIndex] = data;
      }
      setStatus('ローカルに保存 (未ファイル保存)');
      renderList();
      updatePreview();
      markUnsaved(true);
      return true;
    }

    function duplicateCard(){
      if (activeIndex < 0) return;
      const src = JSON.parse(JSON.stringify(cards[activeIndex]));
      src.id = src.id + '_copy';
      cards.splice(activeIndex+1, 0, src);
      activeIndex = activeIndex+1;
      writeForm(src);
      renderList();
      updatePreview();
      markUnsaved(true);
    }

    function deleteCard(){
      if (activeIndex < 0) return;
      const c = cards[activeIndex];
      if (!confirm(`削除しますか？\n${c.id} ${c.name_ja}`)) return;
      cards.splice(activeIndex, 1);
      activeIndex = -1;
      writeForm(defaultCard());
      renderList();
      updatePreview();
      markUnsaved(true);
    }

    // --------- 読み込み/保存（File System Access API + フォールバック）
    function supportsFS(){ return 'showOpenFilePicker' in window || 'showDirectoryPicker' in window; }

    async function connectFolders(){
      if (!supportsFS()){
        alert('このブラウザはFile System Access APIに未対応です。\n保存は「バックアップ書き出し(ダウンロード)」をご利用ください。');
        return;
      }
      try {
        dataDirHandle = await window.showDirectoryPicker({ id: 'pokemon-data-dir' });
        // 探索: master ファイル
        try { masterFileHandle = await dataDirHandle.getFileHandle('cards-master.json', { create: true }); } catch {}
        // サブフォルダ
        try { perCardDirHandle = await dataDirHandle.getDirectoryHandle('cards', { create: true }); } catch {}
        // 画像 (assets/cards)
        assetsDirHandle = await window.showDirectoryPicker({ id: 'pokemon-assets-dir' });
        setStatus('フォルダ接続完了');
      } catch (e) {
        console.warn(e);
        alert('フォルダ接続をキャンセル/失敗しました');
      }
    }

    function normalizeToSpec(arr){
      if (!Array.isArray(arr)) return [];
      return arr.map(c => {
        const out = { ...c };
        // card_type normalize
        if (out.card_type === 'Pokémon') out.card_type = 'Pokemon';
        if (typeof out.card_type === 'string' && out.card_type.includes('Energy')) out.card_type = 'Energy';
        // type -> types
        if (!out.types && out.type) { out.types = [String(out.type)]; delete out.type; }
        // weakness object -> array
        if (out.weakness && !Array.isArray(out.weakness)) { out.weakness = [out.weakness]; }
        // retreat_cost array -> number
        if (Array.isArray(out.retreat_cost)) { out.retreat_cost = out.retreat_cost.length; }
        // stage uppercase -> proper
        if (out.stage === 'BASIC') out.stage = 'Basic';
        if (out.stage === 'STAGE1') out.stage = 'Stage1';
        if (out.stage === 'STAGE2') out.stage = 'Stage2';
        // ability effect_* -> text_*
        if (out.ability && (out.ability.effect_en || out.ability.effect_ja)) {
          out.ability = {
            name_en: out.ability.name_en || '',
            name_ja: out.ability.name_ja || '',
            text_en: out.ability.effect_en || out.ability.text_en || '',
            text_ja: out.ability.effect_ja || out.ability.text_ja || ''
          };
        }
        // attacks effect_* -> text_*
        if (Array.isArray(out.attacks)){
          out.attacks = out.attacks.map(a => ({
            name_en: a.name_en || '',
            name_ja: a.name_ja || '',
            cost: Array.isArray(a.cost) ? a.cost : [],
            damage: (a.damage === 0 || a.damage) ? Number(a.damage) : undefined,
            text_en: a.effect_en || a.text_en || undefined,
            text_ja: a.effect_ja || a.text_ja || undefined,
          }));
        }
        // image -> image_file
        if (!out.image_file && out.image) out.image_file = out.image;
        return out;
      });
    }

    async function openMaster(){
      // 1) まず fetch でローカル同梱を試す
      try {
        const res = await fetch('data/cards-master.json', { cache: 'no-cache' });
        if (res.ok){
          cards = normalizeToSpec(await res.json());
          if (cards.length > 0) {
            activeIndex = 0;
            writeForm(cards[0]);
          } else {
            activeIndex = -1;
            writeForm(defaultCard());
          }
          renderList();
          setStatus('ローカル同梱の master を読込');
          updatePreview();
          return;
        }
      } catch {}

      // 2) File System Access API から
      if (!supportsFS()){
        alert('cards-master.json を読み込めません。サーバー経由で開くか、対応ブラウザでフォルダ接続してください。');
        return;
      }
      try {
        if (!masterFileHandle){
          const [fileHandle] = await window.showOpenFilePicker({ types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]});
          masterFileHandle = fileHandle;
        }
        const file = await masterFileHandle.getFile();
        const text = await file.text();
        cards = normalizeToSpec(JSON.parse(text));
        if (!Array.isArray(cards)) cards = [];
        if (cards.length > 0) {
          activeIndex = 0;
          writeForm(cards[0]);
        } else {
          activeIndex = -1;
          writeForm(defaultCard());
        }
        renderList();
        setStatus('master を読み込みました');
        updatePreview();
      } catch (e) {
        console.error(e);
        alert('master の読み込みに失敗しました');
      }
    }

    async function saveMaster(){
      if (!saveCurrentIntoList()) return;
      // master JSON 文字列
      const json = JSON.stringify(cards, null, 2);

      // File System Access 優先
      if (supportsFS()){
        try {
          if (!masterFileHandle){
            const suggestedName = 'cards-master.json';
            masterFileHandle = await (window.showSaveFilePicker ? window.showSaveFilePicker({ suggestedName }) : dataDirHandle.getFileHandle(suggestedName, { create: true }));
          }
          const writable = await masterFileHandle.createWritable();
          await writable.write(json);
          await writable.close();
          setStatus('master を保存しました');
          markUnsaved(false);
          return;
        } catch (e){ console.warn('FS write failed, fallback download', e); }
      }
      // フォールバック: ダウンロード
      const blob = new Blob([json], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'cards-master.json';
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus('master をダウンロードしました');
      markUnsaved(false);
    }

    async function saveCurrentCardAsFile(){
      if (!saveCurrentIntoList()) return;
      if (!supportsFS() || !perCardDirHandle){
        alert('フォルダ接続が必要です (data/cards)。または master 保存をご利用ください。');
        return;
      }
      const c = cards[activeIndex];
      const fileName = (c.id || 'card') + '.json';
      const handle = await perCardDirHandle.getFileHandle(fileName, { create: true });
      const writable = await handle.createWritable();
      await writable.write(JSON.stringify(c, null, 2));
      await writable.close();
      setStatus('個別カードJSONを保存: ' + fileName);
      markUnsaved(false);
    }

    async function saveImageIfSelected(){
      const fileInput = byId('image_upload');
      if (!fileInput.files || fileInput.files.length === 0) return;
      if (!supportsFS() || !assetsDirHandle){
        alert('画像保存には assets/cards/* へのフォルダ接続が必要です');
        return;
      }
      const file = fileInput.files[0];
      const sub = (byId('card_type').value || 'Pokemon').toLowerCase();
      const subDir = await assetsDirHandle.getDirectoryHandle('cards', { create: true });
      const typeDir = await subDir.getDirectoryHandle(sub, { create: true });
      const fileName = byId('image_file').value.trim() || (byId('id').value.trim() + '.' + (file.name.split('.').pop() || 'webp'));
      const handle = await typeDir.getFileHandle(fileName, { create: true });
      const writable = await handle.createWritable();
      await writable.write(await file.arrayBuffer());
      await writable.close();
      setStatus('画像を保存: ' + fileName);
    }

    // --------- 初期化
    function bind(){
      byId('filterType').addEventListener('change', renderList);
      byId('search').addEventListener('input', renderList);
      byId('btn-new').addEventListener('click', newCard);
      byId('btn-duplicate').addEventListener('click', duplicateCard);
      byId('btn-delete').addEventListener('click', deleteCard);
      byId('btn-save').addEventListener('click', async () => { if (saveCurrentIntoList()){ await saveImageIfSelected(); markUnsaved(true); }});
      byId('btn-save-master').addEventListener('click', saveMaster);
      byId('btn-save-card-json').addEventListener('click', saveCurrentCardAsFile);
      byId('btn-connect').addEventListener('click', connectFolders);
      byId('btn-open-master').addEventListener('click', openMaster);
      byId('btn-export').addEventListener('click', exportBackup);
      byId('btn-validate').addEventListener('click', validateAllCards);
      byId('card_type').addEventListener('change', () => { onTypeChange(); updatePreview(); markUnsaved(true); });
      byId('btn-add-attack').addEventListener('click', () => {
        byId('attacks').appendChild(createAttackBox());
      });

      // Drawer controls
      byId('btn-open-drawer').addEventListener('click', openDrawer);
      byId('btn-close-drawer').addEventListener('click', closeDrawer);
      byId('drawer-backdrop').addEventListener('click', closeDrawer);

      // Preview controls
      byId('btn-prev').addEventListener('click', goPrev);
      byId('btn-next').addEventListener('click', goNext);
      byId('btn-pick-image').addEventListener('click', openImagePicker);
      byId('btn-guess-image').addEventListener('click', () => { const guess = guessImageFile(); if (guess){ byId('image_file').value = guess; updatePreview(); markUnsaved(true);} });
      byId('zoom').addEventListener('input', (e) => { zoomLevel = Number(e.target.value); applyTransform(); });
      byId('btn-zoom-in').addEventListener('click', () => { zoomLevel = Math.min(3, (zoomLevel + 0.1)); byId('zoom').value = zoomLevel.toFixed(1); applyTransform(); });
      byId('btn-zoom-out').addEventListener('click', () => { zoomLevel = Math.max(0.5, (zoomLevel - 0.1)); byId('zoom').value = zoomLevel.toFixed(1); applyTransform(); });
      byId('btn-fit').addEventListener('click', () => { zoomLevel = 1; pan = {x:0,y:0}; byId('zoom').value = '1'; applyTransform(); });
      byId('btn-actual').addEventListener('click', () => { zoomLevel = 1.5; pan = {x:0,y:0}; byId('zoom').value = String(zoomLevel); applyTransform(); });

      const stage = byId('preview-stage');
      stage.addEventListener('wheel', (e) => {
        if (!e.ctrlKey) return;
        e.preventDefault();
        const delta = Math.sign(e.deltaY) * -0.1;
        zoomLevel = Math.min(3, Math.max(0.5, zoomLevel + delta));
        byId('zoom').value = zoomLevel.toFixed(1);
        applyTransform();
      }, { passive: false });
      stage.addEventListener('mousedown', (e) => { isPanning = true; panStart = { x: e.clientX, y: e.clientY }; lastPan = { ...pan }; });
      window.addEventListener('mousemove', (e) => { if (!isPanning) return; const dx = e.clientX - panStart.x; const dy = e.clientY - panStart.y; pan = { x: lastPan.x + dx, y: lastPan.y + dy }; applyTransform(); });
      window.addEventListener('mouseup', () => { isPanning = false; });

      // Form change detection
      $$('#cardForm input, #cardForm select, #cardForm textarea').forEach(el => {
        el.addEventListener('input', () => { markUnsaved(true); if (el.id.startsWith('image')) updatePreview(); });
        el.addEventListener('change', () => { markUnsaved(true); if (el.id.startsWith('image')) updatePreview(); });
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.key === 'k' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); openDrawer(); byId('search').focus(); }
        if (e.key === 's' && (e.ctrlKey || e.metaKey) && e.shiftKey) { e.preventDefault(); saveCurrentCardAsFile(); }
        else if (e.key === 's' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); saveMaster(); }
        if (e.key === 'n' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); newCard(); }
        if (e.key === 'ArrowDown') { e.preventDefault(); goNext(); }
        if (e.key === 'ArrowUp') { e.preventDefault(); goPrev(); }
        if (e.key === 'Escape' && isDrawerOpen()) { closeDrawer(); }
      });

      // Warn on unload if unsaved
      window.addEventListener('beforeunload', (e) => { if (unsaved){ e.preventDefault(); e.returnValue = ''; } });
    }

    async function exportBackup(){
      const json = JSON.stringify(cards, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'cards-master.backup.json';
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus('バックアップを書き出しました');
    }

    async function boot(){
      bind();
      // 既存の data/cards-master.json を fetch し、可能なら最初に表示
      try {
        const res = await fetch('data/cards-master.json', { cache: 'no-cache' });
        if (res.ok) {
          const raw = await res.json();
          cards = normalizeToSpec(raw);
          activeIndex = cards.length ? 0 : -1;
          renderList();
          writeForm(cards[activeIndex] || defaultCard());
          setStatus('ローカル同梱の master を読み込みました');
          updatePreview();
          return;
        }
      } catch {}
      cards = [];
      renderList();
      writeForm(defaultCard());
      setStatus('新規作成を開始できます。 master読込 も可');
      updatePreview();
      // If fetch failed and FS API is available, prompt to open master
      if (supportsFS()) {
        try { await openMaster(); } catch {}
      }
    }

    document.addEventListener('DOMContentLoaded', boot);

    // ---------- Drawer helpers
    function openDrawer(){ byId('drawer').classList.add('open'); }
    function closeDrawer(){ byId('drawer').classList.remove('open'); }
    function isDrawerOpen(){ return byId('drawer').classList.contains('open'); }

    // ---------- Preview helpers
    function currentPreviewUrl(){
      // 1) Uploaded
      const input = byId('image_upload');
      if (input.files && input.files[0]) return URL.createObjectURL(input.files[0]);
      const t = (byId('card_type').value || 'Pokemon').toLowerCase();
      // 2) Explicit filename
      const fileName = (byId('image_file').value || '').trim();
      if (fileName) return `assets/cards/${t}/${fileName}`;
      // 3) Auto-map for Energy
      if (t === 'energy'){
        const et = (byId('energy_type').value || '').trim();
        if (et) return `assets/cards/energy/Energy_${et}.webp`;
      }
      // 4) Heuristic for Pokemon from English name
      if (t === 'pokemon'){
        const en = (byId('name_en').value || '').trim();
        if (en){
          const guess = en.replace(/[^A-Za-z0-9]+/g, '_') + '.webp';
          return `assets/cards/pokemon/${guess}`;
        }
      }
      // 5) No image
      return '';
    }
    function updatePreview(){
      const url = currentPreviewUrl();
      const img = byId('preview-img');
      const empty = byId('preview-empty');
      if (!url){ img.removeAttribute('src'); empty.style.display = 'block'; return; }
      img.src = url;
      img.onerror = () => {
        img.onerror = null;
        img.src = 'assets/ui/card_back.webp';
        empty.textContent = '画像が見つかりません。画像ファイル名またはエネルギータイプを設定してください。';
        empty.style.display = 'block';
      };
      img.onload = () => { empty.style.display = 'none'; };
      applyTransform();
    }
    function applyTransform(){
      const img = byId('preview-img');
      img.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoomLevel})`;
    }
    function goNext(){
      if (cards.length === 0) return;
      const nextIdx = (activeIndex + 1) % cards.length;
      activeIndex = nextIdx;
      writeForm(cards[activeIndex]);
      updatePreview();
      renderList();
    }
    function goPrev(){
      if (cards.length === 0) return;
      const prevIdx = (activeIndex - 1 + cards.length) % cards.length;
      activeIndex = prevIdx;
      writeForm(cards[activeIndex]);
      updatePreview();
      renderList();
    }
  </script>
</body>
</html>
