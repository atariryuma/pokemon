<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しいカード管理システム テスト</title>
    <style>
        body { font-family: system-ui; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-result { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .card-sample { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; border: 2px solid #dee2e6; }
        .card-sample img { width: 100px; height: auto; border-radius: 5px; margin-bottom: 5px; }
        .card-sample.loaded { border-color: #28a745; }
        .card-sample.failed { border-color: #dc3545; }
        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .stats { display: flex; gap: 20px; justify-content: space-around; text-align: center; }
        .stat { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .folder-structure { font-family: monospace; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎴 新しいカード管理システム テスト</h1>
        
        <div class="test-section">
            <h2>📊 システム統計</h2>
            <div class="stats" id="stats-container">
                <div class="stat">
                    <div class="stat-number" id="total-cards">-</div>
                    <div>総カード数</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="pokemon-count">-</div>
                    <div>ポケモン</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="energy-count">-</div>
                    <div>エネルギー</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="data-source">-</div>
                    <div>データソース</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>📁 新フォルダ構造</h2>
            <div class="folder-structure">
data/
├── cards-master.json    # 統合カードデータベース
└── schema.json         # データ検証スキーマ

assets/
├── cards/
│   ├── pokemon/        # ポケモンカード画像
│   └── energy/         # エネルギーカード画像
├── ui/                 # UI用画像
│   ├── card_back.webp
│   └── pokemon_card_back.webp
└── playmat/            # プレイマット関連
            </div>
        </div>

        <div class="test-section">
            <h2>🔍 データローディングテスト</h2>
            <div id="loading-test-results"></div>
        </div>

        <div class="test-section">
            <h2>🖼️ 画像パステスト (ランダム8枚)</h2>
            <div id="image-test-results"></div>
            <div class="card-grid" id="image-samples"></div>
        </div>

        <div class="test-section">
            <h2>✅ システム検証結果</h2>
            <div id="final-results"></div>
        </div>
    </div>

    <script type="module">
        import { loadCardsFromJSON, getCardMasterList, getCardImagePath } from './js/data-manager.js';

        let testResults = {
            dataLoading: false,
            imageLoading: 0,
            totalTests: 0
        };

        // データローディングテスト
        async function testDataLoading() {
            const resultsDiv = document.getElementById('loading-test-results');
            
            try {
                // JSONローディングテスト
                await loadCardsFromJSON();
                const cards = getCardMasterList();
                
                if (cards && cards.length > 0) {
                    testResults.dataLoading = true;
                    
                    // 統計更新
                    document.getElementById('total-cards').textContent = cards.length;
                    document.getElementById('pokemon-count').textContent = cards.filter(c => c.card_type === 'Pokémon').length;
                    document.getElementById('energy-count').textContent = cards.filter(c => c.card_type === 'Basic Energy').length;
                    document.getElementById('data-source').textContent = 'JSON';
                    
                    resultsDiv.innerHTML = `
                        <div class="test-result success">
                            ✅ データローディング成功<br>
                            📦 ${cards.length}枚のカードを読み込みました<br>
                            📄 データソース: data/cards-master.json
                        </div>
                    `;
                    
                    return cards;
                } else {
                    throw new Error('カードデータが空です');
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-result error">
                        ❌ データローディング失敗<br>
                        エラー: ${error.message}
                    </div>
                `;
                return null;
            }
        }

        // 画像パステスト
        async function testImagePaths(cards) {
            if (!cards) return;
            
            const resultsDiv = document.getElementById('image-test-results');
            const samplesDiv = document.getElementById('image-samples');
            
            // ランダムに8枚選択
            const shuffled = [...cards].sort(() => 0.5 - Math.random());
            const testCards = shuffled.slice(0, 8);
            
            testResults.totalTests = testCards.length;
            
            resultsDiv.innerHTML = '<div class="test-result info">🔄 画像読み込みテスト実行中...</div>';
            
            const promises = testCards.map(async (card) => {
                return new Promise((resolve) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card-sample';
                    
                    const img = document.createElement('img');
                    const imagePath = getCardImagePath(card.name_en);
                    img.src = imagePath;
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.textContent = card.name_ja;
                    nameDiv.style.fontSize = '0.8em';
                    nameDiv.style.fontWeight = 'bold';
                    
                    const pathDiv = document.createElement('div');
                    pathDiv.textContent = imagePath.replace('assets/', '');
                    pathDiv.style.fontSize = '0.7em';
                    pathDiv.style.color = '#666';
                    
                    img.onload = () => {
                        cardDiv.classList.add('loaded');
                        testResults.imageLoading++;
                        resolve(true);
                    };
                    
                    img.onerror = () => {
                        cardDiv.classList.add('failed');
                        img.src = 'assets/ui/card_back.webp'; // フォールバック
                        resolve(false);
                    };
                    
                    cardDiv.appendChild(img);
                    cardDiv.appendChild(nameDiv);
                    cardDiv.appendChild(pathDiv);
                    samplesDiv.appendChild(cardDiv);
                });
            });
            
            await Promise.all(promises);
            
            const successRate = (testResults.imageLoading / testResults.totalTests * 100).toFixed(1);
            
            resultsDiv.innerHTML = `
                <div class="test-result ${successRate >= 75 ? 'success' : 'error'}">
                    ${successRate >= 75 ? '✅' : '❌'} 画像読み込みテスト完了<br>
                    📊 成功率: ${successRate}% (${testResults.imageLoading}/${testResults.totalTests})
                </div>
            `;
        }

        // 最終結果表示
        function showFinalResults() {
            const resultsDiv = document.getElementById('final-results');
            
            const overallSuccess = testResults.dataLoading && (testResults.imageLoading / testResults.totalTests) >= 0.5;
            
            resultsDiv.innerHTML = `
                <div class="test-result ${overallSuccess ? 'success' : 'error'}">
                    <h3>${overallSuccess ? '✅ システム検証成功' : '❌ システム検証失敗'}</h3>
                    <ul>
                        <li>データローディング: ${testResults.dataLoading ? '✅ 成功' : '❌ 失敗'}</li>
                        <li>画像パス: ${testResults.imageLoading}/${testResults.totalTests} 成功</li>
                        <li>フォルダ構造: ✅ 整理完了</li>
                        <li>パス更新: ✅ 完了</li>
                    </ul>
                    ${overallSuccess ? 
                        '<p><strong>🎉 新しいカード管理システムは正常に動作しています！</strong></p>' : 
                        '<p><strong>⚠️ システムに問題があります。ログを確認してください。</strong></p>'
                    }
                </div>
            `;
        }

        // テスト実行
        async function runTests() {
            console.log('🔬 新しいカード管理システムのテストを開始します...');
            
            const cards = await testDataLoading();
            await new Promise(resolve => setTimeout(resolve, 500)); // 少し待機
            
            await testImagePaths(cards);
            await new Promise(resolve => setTimeout(resolve, 1000)); // 画像読み込み待機
            
            showFinalResults();
            
            console.log('✅ テスト完了');
        }

        // ページロード時にテスト実行
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>